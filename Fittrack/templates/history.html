{% extends "base.html" %}
{% block title %}History - FitTrack{% endblock %}

{% block content %}
<style>
  .record {
    padding: 40px 20px;
  }

  .history__layout {
    display: flex;
    gap: 40px;
    padding-top: 20px;
  }

  #calendar {
    flex: 1;
    max-width: 60%;
  }

  #recordDetails {
    flex: 1;
    padding: 20px;
    border: 1px solid #ddd;
    background: #f9f9f9;
    border-radius: 8px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
    table-layout: fixed;
  }

  th, td {
    text-align: left;
    padding: 8px;
    border: 1px solid #ccc;
    word-wrap: break-word;
  }

  th {
    background-color: #f0f0f0;
  }

  #recordDetails table.details-table th:first-child,
  #recordDetails table.details-table td:first-child {
    width: 200px;
  }

  #recordDetails table.details-table th:nth-child(2),
  #recordDetails table.details-table td:nth-child(2) {
    width: 300px;
  }

  #recordDetails table.exercise-table th:nth-child(1),
  #recordDetails table.exercise-table td:nth-child(1) {
    width: 35%;
  }

  #recordDetails table.exercise-table th:nth-child(2),
  #recordDetails table.exercise-table td:nth-child(2) {
    width: 25%;
  }

  #recordDetails table.exercise-table th:nth-child(3),
  #recordDetails table.exercise-table td:nth-child(3) {
    width: 40%;
  }

  @media screen and (max-width: 768px) {
    .history__layout {
      flex-direction: column;
    }

    #calendar,
    #recordDetails {
      max-width: 100%;
      width: 100%;
    }

    #calendar {
      min-width: 300px;
      margin-bottom: 20px;
    }
  }

</style>

<div class="record">
  <h1>View Your History</h1>
  <p>Click a date on the calendar to see your records.</p>

  <div class="history__layout">
    <div id="calendar"></div>

    <div id="recordDetails">
      <h2>üóÇ Record Details</h2>
      <table class="details-table">
        <tr><th>Field</th><th>Value</th></tr>
        <tr><td>Date</td><td id="record-date">‚Äî</td></tr>
        <tr><td>Weight (kg)</td><td id="record-weight">‚Äî</td></tr>
        <tr><td>Breakfast</td><td id="record-breakfast">‚Äî</td></tr>
        <tr><td>Lunch</td><td id="record-lunch">‚Äî</td></tr>
        <tr><td>Dinner</td><td id="record-dinner">‚Äî</td></tr>
      </table>

      <h3>üèÉ Exercise Activities</h3>
      <table id="exercise-table" class="exercise-table">
        <thead>
          <tr>
            <th>Type</th>
            <th>Duration (min)</th>
            <th>Intensity</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="3" style="text-align: center;">No exercises</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById("calendar");
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      selectable: true,
      dateClick: function (info) {
        loadRecordDetails(info.dateStr);
      }
    });

    calendar.render();
    markRecordDates();

    const today = new Date().toISOString().split("T")[0];
    loadRecordDetails(today);

    async function markRecordDates() {
      try {
        const res = await fetch('/record_dates');
        const result = await res.json();

        if (result.status === "success") {
          result.dates.forEach(dateStr => {
            calendar.addEvent({
              title: "üìå",
              start: dateStr,
              allDay: true,
              display: 'background',
              backgroundColor: '#ffcccc'
            });
          });
        }
      } catch (err) {
        console.error("Error loading marked dates", err);
      }
    }

    async function loadRecordDetails(dateStr) {
      try {
        const res = await fetch(`/record_details/${dateStr}`);
        const result = await res.json();

        document.getElementById("record-date").textContent = dateStr;
        document.getElementById("record-weight").textContent = "‚Äî";
        document.getElementById("record-breakfast").textContent = "‚Äî";
        document.getElementById("record-lunch").textContent = "‚Äî";
        document.getElementById("record-dinner").textContent = "‚Äî";

        const tableBody = document.getElementById("exercise-table").querySelector("tbody");
        tableBody.innerHTML = "";

        if (result.status === "success") {
          const d = result.data;
          document.getElementById("record-weight").textContent = d.weight || "‚Äî";
          document.getElementById("record-breakfast").textContent = d.breakfast || "‚Äî";
          document.getElementById("record-lunch").textContent = d.lunch || "‚Äî";
          document.getElementById("record-dinner").textContent = d.dinner || "‚Äî";

          if (d.exercises && d.exercises.length > 0) {
            d.exercises.forEach(e => {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${e.type}</td>
                <td>${e.duration}</td>
                <td>${e.intensity}</td>
              `;
              tableBody.appendChild(row);
            });
          } else {
            const row = document.createElement("tr");
            row.innerHTML = `<td colspan="3" style="text-align: center;">No exercises</td>`;
            tableBody.appendChild(row);
          }
        } else {
          const row = document.createElement("tr");
          row.innerHTML = `<td colspan="3" style="text-align: center;">No record found</td>`;
          tableBody.appendChild(row);
        }
      } catch (err) {
        console.error("Failed to fetch record:", err);
        const tableBody = document.getElementById("exercise-table").querySelector("tbody");
        tableBody.innerHTML = `<tr><td colspan="3" style="text-align: center; color: red;">Error loading record</td></tr>`;
      }
    }
  });
</script>
{% endblock %}
