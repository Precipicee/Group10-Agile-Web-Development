{% extends "base.html" %}
{% block title %}Friends - FitTrack{% endblock %}
<meta name="csrf-token" content="{{ csrf_token() }}">

{% block content %}
<div class="profile">
  <h2 class="profile-title">ðŸ‘¥ Friend Management</h2>

  <div class="profile-item">
    <strong>Add a Friend:</strong>
    <input type="text" id="friend-username" class="profile-edit-input" placeholder="Enter username" />
    <button id="btn-send-request" class="edit-btn" style="margin-left: 10px;">Send Request</button>
  </div>

  <hr />

  <div class="profile-item">
    <strong>Friend Requests Received:</strong>
    <div id="received-requests-container" style="margin-top: 5px;">Loading...</div>
  </div>

  <hr />

  <div class="profile-item">
    <strong>Friend Requests Sent:</strong>
    <div id="sent-requests-container" style="margin-top: 5px;">Loading...</div>
  </div>

  <hr />

  <div class="profile-item">
    <strong>Your Friends:</strong>
    <div id="friends-list-container" style="margin-top: 5px;">Loading...</div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("ðŸ‘¥ Friends page JS loaded");

  // Send request
  document.getElementById("btn-send-request").addEventListener("click", async () => {
    const username = document.getElementById("friend-username").value.trim();
    if (!username) return alert("Please enter a username");

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute("content");

    const res = await fetch("/add_friend", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken  
      },
      body: JSON.stringify({ to_username: username })
    });


    const result = await res.json();
    alert(result.message || "Friend request sent");
    location.reload();
  });

  // Load friend data
  fetch("/get_friend_data")
    .then(res => res.json())
    .then(data => {
      renderFriendRequests("received", data.received_requests, "received-requests-container");
      renderFriendRequests("sent", data.sent_requests, "sent-requests-container");
      renderFriendList(data.friends);
    });

  // Render functions
  function renderFriendRequests(type, list, containerId) {
    const container = document.getElementById(containerId);
    if (!list.length) {
      container.innerHTML = `<p>No ${type} requests.</p>`;
      return;
    }

    container.innerHTML = "";
    list.forEach(req => {
      const div = document.createElement("div");
      div.className = "friend-request-entry";
      div.innerHTML = `
        <span>${type === "received" ? "From" : "To"}: ${type === "received" ? req.from_user : req.to_user}</span>
        ${type === "received" ? `
          <button onclick="handleRequest(${req.id}, 'accept')">Accept</button>
          <button onclick="handleRequest(${req.id}, 'reject')">Reject</button>
        ` : `<span>Status: ${req.status}</span>`}
      `;
      container.appendChild(div);
    });
  }

  function renderFriendList(friends) {
    const container = document.getElementById("friends-list-container");
    if (!friends.length) {
      container.innerHTML = "<p>You have no friends yet.</p>";
      return;
    }

    container.innerHTML = "";
    friends.forEach(f => {
      const div = document.createElement("div");
      div.className = "friend-entry";
      div.innerHTML = `
        ${f.username}
        <button class="edit-btn" style="margin-left:10px;" onclick="openShareModal('${f.username}', ${f.user_id})">
          Share Record
        </button>
      `;
      container.appendChild(div);
    });
  }

  // Expose for onclick
  window.handleRequest = async function(requestId, action) {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute("content");

    const res = await fetch("/respond_request", {
      method: "POST",
      headers: { "Content-Type": "application/json" , "X-CSRFToken": csrfToken },
      body: JSON.stringify({ request_id: requestId, action })
    });

    const result = await res.json();
    alert(result.message || "Updated");
    location.reload();
  };
});
let selectedFriendId = null;

window.openShareModal = async function(username, userId) {
  selectedFriendId = userId;
  document.getElementById("share-friend-name").textContent = username;

  const res = await fetch("/record_dates");
  const data = await res.json();

  const select = document.getElementById("record-select");
  select.innerHTML = "";

  if (!data.dates.length) {
    select.innerHTML = "<option>No records available</option>";
  } else {
    data.dates.forEach(date => {
      select.innerHTML += `<option value="${date}">${date}</option>`;
    });
  }

  const modal = new bootstrap.Modal(document.getElementById("shareModal"));
  modal.show();
};

window.shareSelectedRecord = async function () {
  const date = document.getElementById("record-select").value;
  const res = await fetch(`/record_details/${date}`);
  const data = await res.json();

  if (data.status !== "success") {
    alert("Record not found or cannot be shared");
    return;
  }

  console.log("DEBUG â†’ data.data:", data.data);
  console.log("DEBUG â†’ selectedFriendId:", selectedFriendId);


  const recordId = data.data.record_id;

  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute("content");

  const response = await fetch(`/upload/share/${recordId}/${selectedFriendId}`, {
    method: "POST",
    headers: {
    "X-CSRFToken": csrfToken
  }
  });

  if (response.redirected) {
    window.location.href = response.url;
  } else {
    alert("Shared!");
  }
};

</script>
<!-- Share Record Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="padding: 20px;">
      <h4>Share a Record with <span id="share-friend-name"></span></h4>
      <select id="record-select" class="form-control" style="margin-top:10px;"></select>
      <button class="btn btn-primary" style="margin-top: 10px;" onclick="shareSelectedRecord()">Share</button>
    </div>
  </div>
</div>

{% endblock %}